name: ğŸ¤– AI Auto-PR Workflow

on:
  issues:
    types: [opened, reopened, labeled]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  CREW_CONFIG: ./ai/agents.yaml
  GLOBAL_CONTEXT: ./ai/context.md
  MAIN_BRANCH: main

jobs:
  ai-workflow:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§° Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install CrewAI / OpenDevin
        run: |
          pip install opendevin pyyaml requests

      - name: âš™ï¸ Extract issue info
        id: issue
        run: |
          echo "Extracting issue data..."
          echo "number=$(jq -r '.issue.number' $GITHUB_EVENT_PATH)" >> $GITHUB_OUTPUT
          echo "title=$(jq -r '.issue.title' $GITHUB_EVENT_PATH)" >> $GITHUB_OUTPUT
          echo "author=$(jq -r '.issue.user.login' $GITHUB_EVENT_PATH)" >> $GITHUB_OUTPUT
          jq -r '.issue.body' $GITHUB_EVENT_PATH > issue_body.txt

      - name: ğŸ” Detect labels and assign agent
        id: route
        run: |
          python - <<'PYCODE'
          import os, yaml, json, subprocess
          with open(os.environ["CREW_CONFIG"]) as f:
              cfg = yaml.safe_load(f)

          labels = subprocess.check_output(
              ["jq", "-r", ".issue.labels[].name // empty", os.environ["GITHUB_EVENT_PATH"]]
          ).decode().splitlines()
          selected = "pm_agent"
          for agent, data in cfg.items():
              for trig in data.get("triggers", []):
                  if trig.startswith("issue_tag:"):
                      tag = trig.split(":", 1)[1]
                      if tag in labels:
                          selected = agent
                          break
              if selected != "pm_agent":
                  break

          print(f"::set-output name=agent::{selected}")
          PYCODE

      - name: ğŸŒ¿ Create working branch
        id: branch
        run: |
          BRANCH="ai/${{ steps.route.outputs.agent }}/issue-${{ steps.issue.outputs.number }}"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: ğŸ¤– Run AI agent to generate/update code
        run: |
          echo "Running agent: ${{ steps.route.outputs.agent }}"
          echo "Context: $GLOBAL_CONTEXT"
          echo "Simulating AI code generation..."
          mkdir -p ai_output
          python - <<'PYCODE'
          import time, sys
          print("Generating code for issue...", file=sys.stderr)
          with open("ai_output/result.txt", "w") as f:
              f.write(f"# AI generated result for issue\n{open('issue_body.txt').read()}")
          time.sleep(2)
          PYCODE

      - name: ğŸ§¾ Commit and push changes
        run: |
          git config user.name "marmoos-bot"
          git config user.email "bot@marmoos.local"
          cp -r ai_output/* .
          git add .
          git commit -m "ğŸ¤– AI(${{
            steps.route.outputs.agent
          }}): resolve issue #${{
            steps.issue.outputs.number
          }}" || echo "Nothing to commit"
          git push origin "${{ steps.branch.outputs.branch }}"

      - name: ğŸª„ Create Pull Request
        id: pr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.branch.outputs.branch }}
          base: ${{ env.MAIN_BRANCH }}
          title: "ğŸ¤– AI: ${{ steps.route.outputs.agent }} for issue #${{ steps.issue.outputs.number }}"
          body: |
            **Automated AI Contribution**
            - Agent: `${{ steps.route.outputs.agent }}`
            - Source issue: #${{ steps.issue.outputs.number }}
            - Author: @${{ steps.issue.outputs.author }}
            - Context: `${{ env.GLOBAL_CONTEXT }}`
            ---
            Please review this contribution generated by the Marmoos AI Crew.
          labels: "ai-generated, ${{ steps.route.outputs.agent }}"

      - name: ğŸ—£ï¸ Notify issue author
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ steps.issue.outputs.number }}
          body: |
            ğŸ‘‹ Hey @${{ steps.issue.outputs.author }},
            an AI agent **${{ steps.route.outputs.agent }}** just opened PR #${{ steps.pr.outputs.pull-request-number }}  
            with a proposed implementation for your issue.  
            Please review and approve when ready. âš“
